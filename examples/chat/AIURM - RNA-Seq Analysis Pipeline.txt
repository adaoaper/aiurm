===== AIURM • DLR Setup — RNA-Seq Analysis Pipeline (v2.0, demo; 10 genes • 5 Ctrl vs 5 Trt) =====

# Purpose
End-to-end RNA-seq demo with adaptive cognition: QC → normalization → DE → FDR → exploratory pre-FDR filter → GSEA → visuals → explainability → policies → stress tests → audit.

# Governance (optional, for auditability)
as_of = "2025-10-03"
seed = 42
model_version = "LLM_X_demo_v1"
[*run_meta] #0


===== D (Data) =====

D1. Raw RNA-Seq Gene Counts (toy, 5 Control vs 5 Treated, 10 genes)
[
  {"gene":"G1",  "ctrl_1":1500,"ctrl_2":1600,"ctrl_3":1450,"ctrl_4":1550,"ctrl_5":1480, "trt_1":3200,"trt_2":3500,"trt_3":3300,"trt_4":3400,"trt_5":3450},
  {"gene":"G2",  "ctrl_1":  50,"ctrl_2":  60,"ctrl_3":  55,"ctrl_4":  52,"ctrl_5":  63, "trt_1": 150,"trt_2": 140,"trt_3": 160,"trt_4": 155,"trt_5": 145},
  {"gene":"G3",  "ctrl_1":10000,"ctrl_2": 9800,"ctrl_3":10200,"ctrl_4": 9900,"ctrl_5":10150, "trt_1": 9900,"trt_2":10100,"trt_3": 9850,"trt_4":10050,"trt_5": 9950},
  {"gene":"G4",  "ctrl_1": 800,"ctrl_2": 850,"ctrl_3": 750,"ctrl_4": 820,"ctrl_5": 790, "trt_1": 300,"trt_2": 350,"trt_3": 280,"trt_4": 320,"trt_5": 310},
  {"gene":"G5",  "ctrl_1": 400,"ctrl_2": 420,"ctrl_3": 380,"ctrl_4": 410,"ctrl_5": 395, "trt_1": 900,"trt_2": 880,"trt_3": 940,"trt_4": 920,"trt_5": 905},
  {"gene":"G6",  "ctrl_1":2100,"ctrl_2":2050,"ctrl_3":2000,"ctrl_4":2080,"ctrl_5":2010, "trt_1":2050,"trt_2":2020,"trt_3":1980,"trt_4":1990,"trt_5":2030},
  {"gene":"G7",  "ctrl_1":1200,"ctrl_2":1100,"ctrl_3":1250,"ctrl_4":1180,"ctrl_5":1220, "trt_1": 600,"trt_2": 580,"trt_3": 620,"trt_4": 590,"trt_5": 610},
  {"gene":"G8",  "ctrl_1": 300,"ctrl_2": 320,"ctrl_3": 310,"ctrl_4": 305,"ctrl_5": 315, "trt_1": 500,"trt_2": 520,"trt_3": 510,"trt_4": 505,"trt_5": 515},
  {"gene":"G9",  "ctrl_1":  60,"ctrl_2":  65,"ctrl_3":  58,"ctrl_4":  62,"ctrl_5":  61, "trt_1":  62,"trt_2":  60,"trt_3":  64,"trt_4":  63,"trt_5":  62},
  {"gene":"G10","ctrl_1":5000,"ctrl_2":5200,"ctrl_3":5100,"ctrl_4":5150,"ctrl_5":5050, "trt_1":3000,"trt_2":3100,"trt_3":3000,"trt_4":2950,"trt_5":3050}
]
[*data_rna_seq] #0

D2. Gene Lengths (kb) — for RPKM/TPM
{"G1":2.0, "G2":1.5, "G3":2.5, "G4":1.2, "G5":1.8, "G6":2.2, "G7":1.7, "G8":1.3, "G9":1.1, "G10":2.6}
[*data_gene_lengths] #0

D3. Sample Metadata (design matrix, 10 samples)
{
  "samples": [
    {"id":"ctrl_1","condition":"Control","batch":"B1","age":59,"sex":"F","rin":8.4},
    {"id":"ctrl_2","condition":"Control","batch":"B2","age":60,"sex":"M","rin":7.9},
    {"id":"ctrl_3","condition":"Control","batch":"B1","age":61,"sex":"F","rin":8.1},
    {"id":"ctrl_4","condition":"Control","batch":"B3","age":62,"sex":"M","rin":8.0},
    {"id":"ctrl_5","condition":"Control","batch":"B2","age":58,"sex":"F","rin":8.2},

    {"id":"trt_1","condition":"Treated","batch":"B1","age":57,"sex":"F","rin":8.3},
    {"id":"trt_2","condition":"Treated","batch":"B2","age":58,"sex":"M","rin":7.7},
    {"id":"trt_3","condition":"Treated","batch":"B1","age":56,"sex":"F","rin":8.2},
    {"id":"trt_4","condition":"Treated","batch":"B3","age":55,"sex":"M","rin":7.8},
    {"id":"trt_5","condition":"Treated","batch":"B2","age":59,"sex":"F","rin":8.1}
  ],
  "covariates": ["batch","age","sex","rin"]
}
[*data_sample_meta] #0

D4. Gene Sets (toy) — for GSEA / pathway summary
{
  "Hallmark_Inflammation": ["G1","G2"],
  "Hallmark_Metabolism":   ["G3","G4"],
  "Hallmark_CellCycle":    ["G5","G6"],
  "Hallmark_Stress":       ["G7","G8"],
  "Hallmark_Signaling":    ["G9","G10"]
}
[*data_gene_sets] #0

D5. Controls/Anchors (optional)
{
  "housekeeping": ["G3"],
  "negative_controls": [],
  "blacklist_genes": []
}
[*data_controls] #0


===== P (Parameters) — Freedom Switches =====
# What the AI is allowed to vary (and must justify). Overridable by environment.
{
  "normalization_candidates": ["TPM","RPKM","SizeFactor","TMM"],
  "de_models": ["Welch","GLM","Wilcoxon"],
  "batch_methods": ["ComBat","LinearResiduals","None"],
  "fdr_methods": ["BH","BY","Storey"],
  "gsea_rankers": ["signed_log_p","log2FC","t_stat"],
  "policy_mode": "Auto",                             // Auto|Conservative|Exploratory
  "base_mean_filter": {"enabled": true, "min": 10, "strategy": "independent"},
  "outlier_strategy": "review",                      // review|downweight|drop
  "stress": {"loo": true, "permutations": 500, "batch_injection_sd": 0.30},
  "visuals": {"topN_heatmap": 20, "label_topK_volcano": 10},
  "decision_notes": true
}
[*params_ai_freedom] #0


===== L (Logic / Instructions) =====

L0. Build Run Plan from QC + Freedom
- Inspect QC & metadata; choose methods (normalization, batch, DE model, FDR, GSEA ranker) and thresholds per policy.
- Emit JSON with choices and explicit rationale (“why this, not that”).
[*logic_run_plan] #0

L1. QC & Outlier Detection
- Compute library sizes, zero-rates, log-CPM PCA, and an outlier proxy.
- Flag extreme or discordant samples; allow “review” (not only drop).
[*logic_qc] #0

L2. Adaptive Normalization
- Options: RPKM/TPM/Size-Factor/TMM; prefer size-factors under library-size imbalance or many zeros.
- Attach method metadata.
[*logic_normalize_adaptive] #0

L3. Batch & Covariate Adjustment (optional)
- If batch effect indicated, apply ComBat-like or linear residualization; consider age/sex/rin covariates.
[*logic_batch_covariate] #0

L4. Differential Expression (GLM-aware)
- Two-group contrast (Treated vs Control).
- Choose Welch/GLM/Wilcoxon per plan; include covariates if GLM.
- Output per gene: log2FC, stat, p_value (+ n per group).
[*logic_de] #0

L5. Multiple Testing
- Apply FDR (BH/BY/Storey) → q_value.
[*logic_fdr] #0

L6. Filtering & Effect Classification (Main path, post-FDR)
- Default: |log2FC| ≥ 1 and q_value < 0.05; label “Up/Down/Ambiguous”; add short interpretation.
[*logic_filter_effects] #0

L6b. Exploratory Filter (pre-FDR, p-value based)
- Keep genes with |Log2FC| ≥ 0.58 and p_value < 0.10.
- Classify: “Up” (log2FC ≥ 1), “Down” (≤ −1), “Weakly Modulated” (0.58 ≤ |log2FC| < 1); attach interpretation.
[*logic_filter_exploratory] #0

L7. GSEA (Pre-ranked)
- Rank by chosen metric (e.g., signed_log_p); compute toy NES/p-values vs *data_gene_sets.
[*logic_gsea] #0

L8. Biological Annotation (toy)
- Basic descriptions and pathway membership summary.
[*logic_annotate] #0

L9. Visualization Builders (SVG/JSON)
- Volcano, MA, Heatmap (top N), PCA biplot.
[*logic_visuals] #0

L10. Explainability
- Global: why certain methods/thresholds were chosen.
- Local: per-gene rationale for DEG inclusion/exclusion.
[*logic_explain] #0

L11. Policy Modes (threshold presets)
- Conservative: |log2FC| ≥ 1.5, q<0.01, base_mean≥50
- Exploratory: |log2FC| ≥ 0.58, q<0.10, base_mean≥10
[*logic_policies] #0

L12. Stress Tests
- Leave-One-Out; Label Permutation; Batch Injection (synthetic).
[*logic_stress] #0

L13. Provenance & Audit
- Manifest of inputs, methods, thresholds, seeds, hashes; dependency tree (DOT).
[*logic_audit] #0


===== R (Result) — Execution Pipeline =====
# Tip: use direct Apply (no #0) on checkpoints that are reused immediately (R1, R2, R4, R5).

R1. Apply *logic_qc to (*data_rna_seq, *data_sample_meta)  → QC checkpoint
[*results_qc]

R1.1 Build run plan (governed freedom)
Apply *logic_run_plan to (*results_qc, *params_ai_freedom, *data_sample_meta)
[*run_plan]

R2. Apply *logic_normalize_adaptive to (*data_rna_seq, *data_gene_lengths, *results_qc, *run_plan)  → normalization checkpoint
[*expr_norm]

R3. Apply *logic_batch_covariate to (*expr_norm, *data_sample_meta, *results_qc, *run_plan)  → corrected matrix (if needed)
[*expr_corrected]

R4. Apply *logic_de to (*expr_corrected, *data_sample_meta, *run_plan)  → stats (log2FC, p)
[*results_de_stats]

R5. Apply *logic_fdr to (*results_de_stats, *run_plan)  → q-values
[*results_de_fdr]

R6. Apply *logic_filter_effects to *results_de_fdr  → final DEGs + classes
[*results_degs_final]

R6b. Apply *logic_filter_exploratory to *results_de_stats  → exploratory candidates (pre-FDR)
[*results_DEGs_exploratory] #3

R7. Apply *logic_gsea to (*results_de_stats, *data_gene_sets, *run_plan)  → pathway enrichment
[*results_gsea]

R8. Apply *logic_annotate to (*results_degs_final, *results_gsea)  → bio notes
[*results_bio_notes]

R9. Apply *logic_visuals to (*results_degs_final, *expr_norm, *results_qc, *run_plan)  → SVG/JSON plots
[*plots_volcano], [*plots_ma], [*plots_heatmap], [*plots_pca]

R10. Apply *logic_explain to (*results_qc, *logic_normalize_adaptive, *logic_de, *logic_filter_effects, *run_plan) → global+local explanations
[*results_explainability]

R11. Apply *logic_policies to (*results_de_fdr, *run_plan) → two filtered views
[*results_conservative], [*results_exploratory]

R12. Apply *logic_stress to (*data_rna_seq, *data_sample_meta, *expr_norm, *results_de_fdr, *run_plan) → stability & FPR
[*results_stress_suite]

R13. Apply *logic_audit to all inputs/outputs → manifest + DOT
[*audit_manifest], [*dependency_tree_rnaseq_dot]


===== Quick Shows (on demand) =====
# Start with #1 (summary). Repeat with #3 for details as needed.

Show *run_plan #1
Show *results_qc #1
Show *expr_norm #1
Show *results_degs_final #1
Show *results_DEGs_exploratory #1
Show *results_gsea #1
Show *plots_volcano #1
Show *results_explainability #1
Show *results_conservative #1
Show *results_exploratory #1
Show *results_stress_suite #1
Show *audit_manifest #1
Show *dependency_tree_rnaseq_dot #1


===== Post-hoc Exploratory Snapshot (end-of-flow) =====
# Reuse the existing *logic_filter_exploratory (do NOT redefine it here).

R14. Apply *logic_filter_exploratory to *results_de_stats  → pre-FDR exploratory candidates
[*results_DEGs_exploratory_final] #0

# Consolidate what is only-exploratory (did not pass FDR), what overlaps with FDR,
# and which exploratory hits are stable under stress tests (if available).
Logic — Build exploratory summary from:
  inputs: *results_DEGs_exploratory_final, *results_degs_final, *results_stress_suite (optional)
  steps:
    - exploratory_only     = DEGs_exploratory_final \ degs_final
    - exploratory_overlap  = DEGs_exploratory_final ∩ degs_final
    - stable_exploratory   = genes in DEGs_exploratory_final that remain flagged under LOO/permutation
    - produce counts, top-K tables (by |log2FC| then p), and brief notes
  output:
  {
    "counts": {
      "exploratory_total": <int>,
      "overlap_with_FDR": <int>,
      "only_exploratory": <int>,
      "stable_exploratory": <int>
    },
    "only_exploratory_top": [...],
    "stable_exploratory_top": [...],
    "notes": "Use these for orthogonal validation / targeted assays."
  }
[*logic_exploratory_summary] #0

R15. Apply *logic_exploratory_summary
[*exploratory_summary] #0

# Quick Shows
Show *results_DEGs_exploratory_final #3
Show *exploratory_summary #3


==========================================================

AIURM Protocol v0.1 (Experimental Draft)
Artificial Intelligence Universal Reference Marker

Public domain (CC0)
No stability guarantees are provided.

Created by Adão Aparecido Ernesto (2025)
Email: adaoernesto@aiurm.org
X: @adaoaper
GitHub: https://github.com/adaoaper/aiurm

Website: https://aiurm.org
==========================================================



